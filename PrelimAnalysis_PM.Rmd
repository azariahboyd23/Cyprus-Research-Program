### Preliminary Analysis

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

library("readxl")
library("dplyr")
library("tidyverse")

getwd()
data <- read_xlsx("/Users/AB/Desktop/Cyprus-Research-Program/Clean DataLogs for impactors and Alphasense(cor_Dates+ Match Alphasense)_Updated AM 30-10-22 .xlsx")
data

# Trimming 
df <- data %>% select(`PM (PM2.5,PM10)`, Average, Median, 
                     `PM MASS (μg/m3)`, `Impactor Location (Indoor/Outdoor)`,
                     Flag, `INTERVENTION GROUP`, `Dust(D)/ NonDust(ND)`)

#provisionally ignore subjects with missing values 
df <- df[which(!is.na(df$Median)),] 

df <- df[which(!is.na(df$Average)),] 

#making PM MASS values numeric 
df$`PM MASS (μg/m3)` <- as.numeric(df$`PM MASS (μg/m3)`)
df <- df[which(!is.na(df$`PM MASS (μg/m3)`)),] #removing N/As 

# Create PM2.5 data set. Removing flag 2  
PM2.5 <- df %>% filter(`PM (PM2.5,PM10)` == "PM2.5", Flag != "2")
PM2.5

# Create PM10 data set. Removing flag 2  
PM10 <- df %>% filter(`PM (PM2.5,PM10)` == "PM10", Flag != "2")
PM10
```

#### The inital look at the data...
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

library("ggplot2")
library("ggthemes")
library("ggrepel")

hist1 <- df %>% 
  ggplot(aes(`PM MASS (μg/m3)`, ..density..)) + 
  geom_histogram(binwidth = 4, color="black", fill="navy") + 
  xlab("PM MASS (μg/m3) HI") 

hist2 <- df %>% 
  ggplot(aes(log(`PM MASS (μg/m3)`), ..density..)) + 
  geom_histogram(binwidth = 0.25, color="black", fill="navy") + 
  xlab("Log of PM MASS (μg/m3) HI") 

hist3 <- PM2.5 %>% 
  ggplot(aes(Average, ..density..)) + 
  geom_histogram(binwidth = 2, color="black", fill="navy") + 
  xlab("Average PM2.5(μg/m3) Alphasensor") 

hist4 <- PM2.5 %>% 
  ggplot(aes(log(Average), ..density..)) + 
  geom_histogram(binwidth = 0.5, color="black", fill="navy") + 
  xlab("Log Average PM2.5(μg/m3) Alphasensor") 

hist5 <- PM10 %>% 
  ggplot(aes(Average, ..density..)) + 
  geom_histogram(binwidth = 5, color="black", fill="navy") + 
  xlab("Average PM10 (μg/m3) Alphasensor") 

hist6 <- PM10 %>% 
  ggplot(aes(log(Average), ..density..)) + 
  geom_histogram(binwidth = 0.5, color="black", fill="navy") + 
  xlab("Log Average PM10 (μg/m3) Alphasensor") 

library("gridExtra")
grid.arrange(hist1, hist2, hist3, hist4, hist5, hist6, nrow = 3)
```


### Correlation 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(ggplot2)
library(ggpubr)
library(ggrepel)

# R^2 (coefficient of determination) is the proportion of the variance in the  
# average that is predicted by PM Mass. In other words, how well does avg. 
# predict PM Mass? 

p1 <- PM2.5 %>% 
    ggplot(aes(x = Average, y = `PM MASS (μg/m3)`)) + 
    geom_point(color="navy", size = 3, alpha=0.5) +  
    geom_smooth(method=lm, se=TRUE, col="black", size=1) +
    stat_regline_equation(label.x=40, label.y=90) +
    stat_cor(aes(label=..rr.label..), label.x=40, label.y=82) +
    ylab("PM Mass (μg/m3) HI") + 
    xlim(0, 80) + 
    ylim(0, 100) + 
    xlab("Average PM2.5 (μg/m3) Alphasensor") +
    theme_classic() + 
    theme(legend.position = "none") 

p2 <- PM2.5 %>% 
    ggplot(aes(x = log(Average), y = `PM MASS (μg/m3)`)) + 
    geom_point(color="navy", size = 3, alpha=0.5) +  
    geom_smooth(method=lm, se=TRUE, col="black", size=1) +
    stat_regline_equation(label.x=2, label.y=40) +
    stat_cor(aes(label=..rr.label..), label.x=2, label.y=35) +
    ylab("PM Mass (μg/m3) HI") + 
    xlab("Log Average PM2.5 (μg/m3) Alphasenor") +
    theme_classic() + 
    theme(legend.position = "none")

p3 <- PM10 %>% 
  ggplot(aes(x = Average, y = `PM MASS (μg/m3)`)) + 
  geom_point(color="navy", size = 3, alpha=0.5) +
  geom_smooth(method=lm, se=TRUE, col="black", size=0.5) +
  stat_regline_equation(label.x=31, label.y=150) +
  stat_cor(aes(label=..rr.label..), label.x=31, label.y=130) +
  xlim(0, 50) + 
  ylim(0, 200) +
  ylab("PM Mass (μg/m3) HI") + 
  xlab("Average PM10 (μg/m3) Alphasensor") +
  theme_classic() + 
  theme(legend.position = "none") 

p4 <- PM10 %>% 
  ggplot(aes(x = log(Average), y = `PM MASS (μg/m3)`)) + 
  geom_point(color="navy", size = 3, alpha=0.5) +
  geom_smooth(method=lm, se=TRUE, col="black", size=0.5) +
  stat_regline_equation(label.x=3, label.y=150) +
  stat_cor(aes(label=..rr.label..), label.x=3, label.y=135) +
  ylab("PM Mass (μg/m3) HI") + 
  xlab("Log Average PM10 (μg/m3) Alphasensor") +
  theme_classic() + 
  theme(legend.position = "none") 

grid.arrange(p1, p2, p3, p4, nrow = 2)
```

#### Linear Regression Models 

##### Relationship between PM2.5 from Alphasenors and PM Mass from Harvard Impactor.
##### **Un-transformed data** 
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
model1 <- lm(`PM MASS (μg/m3)` ~ Average, data=PM2.5)  #PM2.5 
summary(model1)
```

##### Relationship between PM2.5 from Alphasenors and PM Mass from Harvard Impactor.
##### Adjusting for dust and intervention status 
```{r}
model2 <- glm(`PM MASS (μg/m3)`~ Average + `INTERVENTION GROUP` + 
               `Dust(D)/ NonDust(ND)`, data=PM2.5)
summary(model2)

# diagnostics for linear regression. plot the residuals 
augment(model2)
```



##### Relationship between PM2.5 from Alphasenors and PM Mass from Harvard Impactor.
##### **Transformed data** 
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
model2 <- lm(log(`PM MASS (μg/m3)`) ~ log(Average), data=PM2.5)  #PM2.5 
summary(model2)
```


##### Relationship between PM10 from Alphasenors and PM Mass from Harvard Impactor.
##### **Un-transformed data** 
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
model3 <- lm(`PM MASS (μg/m3)` ~ Average, data=PM10)  #PM2.5 
summary(model3)
```


##### Relationship between PM10 from Alphasenors and PM Mass from Harvard Impactor.
##### **Transformed data**
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
model4 <- lm(log(`PM MASS (μg/m3)`) ~ log(Average), data=PM10)  #PM2.5 
summary(model4)
```


##### Particulate Matter Measurements over Time 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

library(dplyr)
library(readr)
library(ggplot2)
library(ggthemes)

df2 <- data %>% select(`PM (PM2.5,PM10)`, Average, Median, 
                     `PM MASS (μg/m3)`, `Impactor Location (Indoor/Outdoor)`,
                     Flag, `Sampling time (min) With Correction timestamps`) %>%
  filter(Flag != "2")

df2 <- df2[which(!is.na(df2$`PM MASS (μg/m3)`)),]   # remove missing values 
df2 <- df2[which(!is.na(df2$Average)),] 
df2 <- df2[which(!is.na(df2$Median)),] 

write.csv(df2, "~/Desktop/df2.csv")
df2 <- read_csv("~/Desktop/df2_edit.csv")

#making PM MASS values numeric 
df2$`PM MASS (μg/m3)` <- as.numeric(df2$`PM MASS (μg/m3)`)

df2 %>% ggplot(aes(x = `Sampling time (min) With Correction timestamps`, 
                   `PM MASS (μg/m3)`, y = Average, color = `PM (PM2.5,PM10)`)) + 
  labs(color = "PM") +
  geom_point(alpha = 0.3) +
  stat_smooth(method = loess, se = FALSE) +
  ylim(0, 74) +
  ylab("Average Particulate Matter (μg/m3)") +
  xlab("Sampling Time (minutes)") + 
  theme_clean()
```


