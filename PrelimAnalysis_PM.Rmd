### Preliminary Analysis

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

library("readxl")
library("dplyr")
library("tidyverse")
library(psych)

getwd()
data <- read_xlsx("/Users/AB/Desktop/Cyprus-Research-Program/Clean DataLogs for impactors and Alphasense(cor_Dates+ Match Alphasense)_Updated AM 30-10-22  copy.xlsx")

# Trimming 
df <- data %>% select(`PM (PM2.5,PM10)`, Average, Median, 
                     `PM MASS (μg/m3)`, `Impactor Location (Indoor/Outdoor)`,
                     Flag, `INTERVENTION GROUP`, `Dust(D)/ NonDust(ND)`)

#provisionally ignore subjects with missing values 
df <- df[which(!is.na(df$Median)),] 

df <- df[which(!is.na(df$Average)),] 

#making PM MASS values numeric 
df$`PM MASS (μg/m3)` <- as.numeric(df$`PM MASS (μg/m3)`)
df <- df[which(!is.na(df$`PM MASS (μg/m3)`)),] #removing N/As 

# Create PM2.5 data set. Removing flag 2  
PM2.5 <- df %>% filter(`PM (PM2.5,PM10)` == "PM2.5", Flag != "2", 
                       Average != "35.26")

# creating PM2.5 df without outliers 
boxplot(PM2.5$Average)
boxplot(PM2.5$`PM MASS (μg/m3)`)

PM2.5_no_outlier <- PM2.5 %>% filter(Average != "35.2582041", 
                                     `PM MASS (μg/m3)`!= 47.255555) 
boxplot(PM2.5_no_outlier$Average)
boxplot(PM2.5_no_outlier$`PM MASS (μg/m3)`)

rename(PM2.5_no_outlier, AveragePM2.5 = Average) #remaining column 

# Create PM10 data set. Removing flag 2  
PM10 <- df %>% filter(`PM (PM2.5,PM10)` == "PM10", Flag != "2")

# creating PM10 df without outliers 
boxplot(PM10$Average) 
boxplot(PM10$`PM MASS (μg/m3)`)

PM10_no_outlier <- PM10 %>% filter(Average != "212.23553") %>%
  filter(Average != "67.42289358", `PM MASS (μg/m3)`!= "175.291046") 

PM10_no_outlier <- PM10 %>% filter(Average != "67.422894")

boxplot(PM10_no_outlier$Average)
boxplot(PM10_no_outlier$`PM MASS (μg/m3)`)
```

#### An inital look at the data...
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

library("ggplot2")
library("ggthemes")
library("ggrepel")

hist1 <- PM2.5_no_outlier %>% 
  ggplot(aes(`PM MASS (μg/m3)`, ..density..)) + 
  geom_histogram(binwidth = 1, color="black", fill="navy") +
  xlab("PM MASS (μg/m3) HI") 

hist2 <- PM2.5_no_outlier %>% 
  ggplot(aes(log(`PM MASS (μg/m3)`), ..density..)) + 
  geom_histogram(binwidth = 0.25, color="black", fill="navy") + 
  xlab("Log of PM MASS (μg/m3) HI") 

hist3 <- PM2.5_no_outlier %>% 
  ggplot(aes(Average, ..density..)) + 
  geom_histogram(binwidth = 0.5, color="black", fill="navy") + 
  xlim(0, 20)
  xlab("Average PM2.5(μg/m3) Alphasensor") 

hist4 <- PM2.5_no_outlier %>% 
  ggplot(aes(log(Average), ..density..)) + 
  geom_histogram(binwidth = 0.25, color="black", fill="navy") + 
  xlab("Log Average PM2.5(μg/m3) Alphasensor")

hist5 <- PM10_no_outlier %>% 
  ggplot(aes(Average, ..density..)) + 
  geom_histogram(binwidth = 5, color="black", fill="navy") + 
  xlab("Average PM10 (μg/m3) Alphasensor") 

hist6 <- PM10_no_outlier %>% 
  ggplot(aes(log(Average), ..density..)) + 
  geom_histogram(binwidth = 0.25, color="black", fill="navy") + 
  xlab("Log Average PM10 (μg/m3) Alphasensor") 

library("gridExtra")
grid.arrange(hist1, hist2, hist3, hist4, hist5, hist6, nrow = 3)
```

#### Linear Regression Models 
##### Average PM2.5 from Alphasenors predicting PM Mass from Harvard Impactor. Unadjusted
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
library(broom)
library(ggplot2)
library(ggpubr)
library(ggrepel)
library("gridExtra")

install.packages("sjPlot")
library(sjPlot)

model1 <- lm(`PM MASS (μg/m3)` ~ Average, data=PM2.5_no_outlier)  
#PM2.5 # R^2 (coefficient of determination) is the proportion of the variance in the  
# average that is predicted by PM Mass. In other words, how well does avg. 
# predict PM Mass? 

model2 <- lm(`PM MASS (μg/m3)` ~ log(Average), data=PM2.5_no_outlier)  

tab_model(model1, model2)

p1 <- PM2.5_no_outlier %>% 
    ggplot(aes(x = Average, y = `PM MASS (μg/m3)`)) + 
    geom_point(color="navy", size = 3, alpha=0.5) +  
    geom_smooth(method=lm, se=TRUE, col="black", size=1) +
    stat_regline_equation(label.x=3.5, label.y=23) +
    stat_cor(aes(label=..rr.label..), label.x=3.5, label.y=20) +
    ylab("PM Mass (μg/m3) HI") + 
    xlab("Average PM2.5 (μg/m3) Alphasensor") +
    theme_classic() + 
    theme(legend.position = "none") 


p2 <-  PM2.5_no_outlier %>% 
    ggplot(aes(x = log(Average), y = `PM MASS (μg/m3)`)) + 
    geom_point(color="navy", size = 3, alpha=0.5) +  
    geom_smooth(method=lm, se=TRUE, col="black", size=1) +
    stat_regline_equation(label.x=0.2, label.y=20) +
    stat_cor(aes(label=..rr.label..), label.x=0.2, label.y=17) +
    ylab("PM Mass (μg/m3) HI") + 
    xlab("Log Average PM2.5 (μg/m3) Alphasensor") +
    theme_classic() + 
    theme(legend.position = "none") 

grid.arrange(p1, p2, nrow = 2)
```

##### Average PM2.5 from Alphasenors predicting PM Mass from Harvard Impactor. Adjusting for dust and intervention status. 
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

# adding covariates
model3 <- glm(`PM MASS (μg/m3)`~ log(Average) + `INTERVENTION GROUP` + 
               `Dust(D)/ NonDust(ND)`, data=PM2.5_no_outlier)

# adding interaction term
model4 <- glm(`PM MASS (μg/m3)`~ log(Average) + `INTERVENTION GROUP` +
                `Dust(D)/ NonDust(ND)` + `INTERVENTION GROUP` * `Dust(D)/ NonDust(ND)`,
              data = PM2.5_no_outlier)

tab_model(model3, model4)
``` 


```{r eval=FALSE, include=FALSE}
library(car) 

#plotting the regression line of adjusted models for PM2.5 
avPlots(model3, terms=~., intercept = FALSE, layout = NULL, grid = FALSE, 
        ellipse=FALSE, pt.wts = FALSE, lwd =2)

avPlots(model4, terms=~., intercept = FALSE, layout = NULL, grid = FALSE, 
        ellipse=FALSE, pt.wts = FALSE, lwd =2)
```


##### Average PM10 from Alphasenors on PM Mass from Harvard Impactor.
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

model5 <- lm(`PM MASS (μg/m3)` ~ Average, data=PM10_no_outlier)  

model6 <- lm(`PM MASS (μg/m3)` ~ log(Average), data=PM10_no_outlier)  

tab_model(model5, model6)

p3 <- PM10_no_outlier %>% 
  ggplot(aes(x = Average, y = `PM MASS (μg/m3)`)) + 
  geom_point(color="navy", size = 3, alpha=0.5) +
  geom_smooth(method=lm, se=TRUE, col="black", size=0.5) +
  stat_regline_equation(label.x=5, label.y=60) +
  stat_cor(aes(label=..rr.label..), label.x=5, label.y=50) +
  xlim(0, 45) + 
  ylim(0, 75) +
  ylab("PM Mass (μg/m3) HI") + 
  xlab("Average PM10 (μg/m3) Alphasensor") +
  theme_classic() + 
  theme(legend.position = "none") 


p4 <- PM10_no_outlier %>% 
  ggplot(aes(x = log(Average), y = `PM MASS (μg/m3)`)) + 
  geom_point(color="navy", size = 3, alpha=0.5) +
  geom_smooth(method=lm, se=TRUE, col="black", size=0.5) +
  stat_regline_equation(label.x=0.5, label.y=35) +
  stat_cor(aes(label=..rr.label..), label.x=0.5, label.y=29) +
  xlim(0, 4) + 
  ylim(0, 47) +
  ylab("PM Mass (μg/m3) HI") + 
  xlab("Log Average PM10 (μg/m3) Alphasensor") +
  theme_classic() + 
  theme(legend.position = "none") 


grid.arrange(p3, p4, nrow = 2)
```

##### Average PM10 from Alphasenors and PM Mass from Harvard Impactor. Adjusting for dust and intervention status. 
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
#adding covariates 
model6 <- glm(`PM MASS (μg/m3)`~ log(Average) + `INTERVENTION GROUP` + 
               `Dust(D)/ NonDust(ND)`, data=PM10_no_outlier)

# adding interaction term
model7 <- glm(`PM MASS (μg/m3)`~ log(Average) + `INTERVENTION GROUP` +
                `Dust(D)/ NonDust(ND)` + `INTERVENTION GROUP` * `Dust(D)/ NonDust(ND)`,
              data = PM10_no_outlier)

tab_model(model6, model7)
```

```{r eval=FALSE, include=FALSE}
#plotting the regression line of adjusted models for PM10
avPlots(model4, terms=~., intercept = FALSE, layout = NULL, grid = FALSE, 
        ellipse=FALSE, pt.wts = FALSE, lwd =2)
```

#### Y = Predicted Alphasense PM, X = Actual Alphasense PM Measurement 
```{r}
predict(model2)


```

#### Plotting Observed vs. Predicted Values 
```{r}

ggplot(PM2.5_no_outlier, aes(x=predict(model2), 
           y= (PM2.5_no_outlier$`PM MASS (μg/m3)`))) +
  geom_point() +
  geom_abline(intercept=0, slope=1) +
  labs(x='Predicted Log Average PM2.5 Values', y='Actual Log Average PM2.5 Values', title='Predicted vs. Actual Values')

```

#### Particulate Matter Measurements over Time 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

library(dplyr)
library(readr)
library(ggplot2)
library(ggthemes)

df2 <- data %>% select(`PM (PM2.5,PM10)`, Average, Median, 
                     `PM MASS (μg/m3)`, `Impactor Location (Indoor/Outdoor)`,
                     Flag, `Sampling time (min) With Correction timestamps`) %>%
  filter(Flag != "2")

df2 <- df2[which(!is.na(df2$`PM MASS (μg/m3)`)),]   # remove missing values 
df2 <- df2[which(!is.na(df2$Average)),] 
df2 <- df2[which(!is.na(df2$Median)),] 

write.csv(df2, "~/Desktop/df2.csv")
df2 <- read_csv("~/Desktop/df2_edit.csv")

#making PM MASS values numeric 
df2$`PM MASS (μg/m3)` <- as.numeric(df2$`PM MASS (μg/m3)`)

df2 %>% ggplot(aes(x = `Sampling time (min) With Correction timestamps`, 
                   `PM MASS (μg/m3)`, y = Average, color = `PM (PM2.5,PM10)`)) + 
  labs(color = "PM") +
  stat_smooth(method = loess, se = FALSE) +
  ylim(0, 40) +
  ylab("Average Particulate Matter (μg/m3)") +
  xlab("Sampling Time (minutes)") + 
  theme_clean()
```


